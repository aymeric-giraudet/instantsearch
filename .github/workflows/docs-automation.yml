name: Documentation Automation

on:
  # Trigger on push to master (for release commits)
  push:
    branches:
      - master

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      run_claude:
        description: 'Run Claude Code'
        default: false
        type: boolean
      create_pr:
        description: 'Create PR'
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    # Only run on release commits or manual triggers
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.head_commit.message, 'chore:' )

    steps:
      - name: Checkout instantsearch
        uses: actions/checkout@v4
        with:
          path: instantsearch

      - name: Clone docs-new repository
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_REPO_PAT }}@github.com/algolia/docs-new.git docs-new
          cd docs-new
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: docs-new
        run: |
          claude -p "You are updating documentation for InstantSearch.

          ## Task

          1. Read the changelogs to understand what changed in the latest release:
             - ../instantsearch/packages/instantsearch.js/CHANGELOG.md
             - ../instantsearch/packages/react-instantsearch/CHANGELOG.md
             - ../instantsearch/packages/vue-instantsearch/CHANGELOG.md

          2. Explore this documentation repository to understand its structure:
             - Use Glob to find InstantSearch-related docs
             - Read a few existing widget/hook docs to understand the format

          3. Update documentation for any new features, modified components, or breaking changes.

          ## Flavor Mapping

          Each package has its own documentation flavor:
          - instantsearch.js → .js.mdx files
          - react-instantsearch → .react.mdx files
          - vue-instantsearch → .vue.mdx files

          ## Guidelines

          - Focus on the LATEST release section in each changelog
          - For new widgets/hooks, create new .{flavor}.mdx files following existing patterns
          - For modified components, update existing docs with new props/options
          - For breaking changes, update migration guides if applicable
          - Match the existing documentation format and style exactly
          - Only modify documentation files
          - Don't add placeholder content - only document what actually exists

          ## Source Code Reference

          The InstantSearch source is at ../instantsearch for reference.
          Read source files to understand APIs, types, and implementation.
          Example: ../instantsearch/packages/instantsearch.js/src/widgets/" \
            --allowedTools "Read,Edit,Write,Bash(git diff *),Bash(git status *),Glob,Grep" \
            --output-format text

      - name: Show what Claude would do (dry run)
        if: github.event_name == 'workflow_dispatch' && inputs.run_claude == false
        run: |
          echo "## Dry Run Mode"
          echo ""
          echo "Would run Claude with prompt to:"
          echo "1. Read changelogs from instantsearch packages"
          echo "2. Explore docs-new structure"
          echo "3. Update documentation for new features/changes"
          echo ""
          echo "Trigger with run_claude=true to actually run Claude."

      - name: Install docs-new dependencies
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        run: npm ci

      - name: Run style guide check
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        continue-on-error: true
        run: npm run check:styleguide || echo "Style guide check not available or failed"

      - name: Run link check
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_claude == true)
        working-directory: docs-new
        continue-on-error: true
        run: npm run check:links || echo "Link check not available or failed"

      - name: Show changes (no PR)
        if: github.event_name == 'workflow_dispatch' && inputs.run_claude == true && inputs.create_pr == false
        working-directory: docs-new
        run: |
          echo "## Changes made by Claude"
          echo ""
          git status
          echo ""
          git diff || true
          echo ""
          echo "---"
          echo "To create a PR, trigger the workflow with create_pr=true"

      - name: Create branch and commit
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_pr == true)
        working-directory: docs-new
        run: |
          DATE=$(date +%Y%m%d)
          BRANCH="docs/release-${DATE}"

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch and commit
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "docs: update documentation for release

          Auto-generated by InstantSearch docs automation.

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # Push branch
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.branch != '' && (github.event_name == 'push' || inputs.create_pr == true)
        env:
          GITHUB_TOKEN: ${{ secrets.DOCS_REPO_PAT }}
        working-directory: docs-new
        run: |
          gh pr create \
            --repo algolia/docs-new \
            --title "docs: update documentation for release" \
            --body "## Summary

          Auto-generated documentation update for InstantSearch release.

          ## Source
          - [Release workflow](https://github.com/algolia/instantsearch/actions/runs/${{ github.run_id }})

          ## Review Checklist
          - [ ] Content is accurate and complete
          - [ ] Code examples work correctly
          - [ ] Links are valid
          - [ ] Formatting follows documentation style guide

          ---
          *Generated by [InstantSearch Docs Automation](https://github.com/algolia/instantsearch)*" \
            --draft \
            --label "documentation" \
            --label "auto-generated"

      - name: Summary
        run: |
          echo "## Documentation Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "### Manual Run Settings" >> $GITHUB_STEP_SUMMARY
            echo "- **Run Claude:** ${{ inputs.run_claude }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Create PR:** ${{ inputs.create_pr }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ env.branch }}" ]]; then
            echo "### Result" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ env.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A draft PR has been created in algolia/docs-new." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.run_claude }}" == "false" ]]; then
            echo "**Dry run mode.** Check the logs to see what would happen." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.create_pr }}" == "false" ]]; then
            echo "**Preview mode.** Claude ran but no PR was created. Check the logs to see changes." >> $GITHUB_STEP_SUMMARY
          fi
